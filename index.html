<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Farm Report Viewer & Saver</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: auto;
      padding: 20px;
      background: #f9f9f9;
    }
    h1 {
      text-align: center;
      margin-bottom: 25px;
    }
    #controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    input[type="file"] {
      padding: 8px;
      font-size: 14px;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 16px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
    }
    button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background-color: #007bff;
      color: white;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr.date-separator td {
      border-top: 3px solid #333;
      padding-top: 20px;
      background-color: #f0f0f0;
    }
    tr.total-row td {
      font-weight: bold;
      background-color: #e2e2e2;
    }
    @media print {
      #controls {
        display: none !important;
      }
      table {
        page-break-inside: avoid;
        font-size: 12pt;
      }
      tr.date-separator td {
        border-top: 5px solid black !important;
        padding-top: 30px !important;
        background: white !important;
      }
    }
    #message {
      text-align: center;
      margin-top: 15px;
      color: green;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h1>Farm Report Viewer & Saver</h1>

  <div id="controls">
    <input type="file" id="fileInput" accept=".json" />
    <button id="uploadBtn">Upload & View JSON</button>
    <button id="saveBtn" disabled>Save to Cloud</button>
    <button id="printBtn" disabled>Print / Save PDF</button>
  </div>

  <table id="reportTable" style="display:none;">
    <thead>
      <tr>
        <th>DATE</th>
        <th>FARM NAME</th>
        <th>333</th>
        <th>332</th>
        <th>331</th>
        <th>330</th>
        <th>313-B</th>
      </tr>
    </thead>
    <tbody id="reportBody"></tbody>
    <tfoot id="reportFooter"></tfoot>
  </table>

  <div id="message"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = 'https://stbfwvkefvmpoudgoawf.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN0YmZ3dmtlZnZtcG91ZGdvYXdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODg0MDEsImV4cCI6MjA3NTQ2NDQwMX0.-dyYLle7l08xzRShcLVKjcBGw3Qo4cD3DItJn0mJPp0';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const saveBtn = document.getElementById('saveBtn');
    const printBtn = document.getElementById('printBtn');
    const reportTable = document.getElementById('reportTable');
    const reportBody = document.getElementById('reportBody');
    const reportFooter = document.getElementById('reportFooter');
    const messageDiv = document.getElementById('message');

    let reportData = [];

    function renderReport(data) {
      if (!data.length) {
        reportTable.style.display = 'none';
        saveBtn.disabled = true;
        printBtn.disabled = true;
        return;
      }
      reportBody.innerHTML = '';
      reportFooter.innerHTML = '';
      let prevDate = null;

      let totals = { '333': 0, '332': 0, '331': 0, '330': 0, '313-B': 0 };

      data.forEach(entry => {
        const tr = document.createElement('tr');
        if (entry.date !== prevDate) {
          tr.classList.add('date-separator');
          prevDate = entry.date;
        }

        function valOrEmpty(key) {
          return entry[key] ? entry[key] : '';
        }

        tr.innerHTML = `
          <td>${entry.date || ''}</td>
          <td>${entry.farm || ''}</td>
          <td>${valOrEmpty('333')}</td>
          <td>${valOrEmpty('332')}</td>
          <td>${valOrEmpty('331')}</td>
          <td>${valOrEmpty('330')}</td>
          <td>${valOrEmpty('313-B')}</td>
        `;

        ['333','332','331','330','313-B'].forEach(k => {
          totals[k] += Number(entry[k]) || 0;
        });

        reportBody.appendChild(tr);
      });

      const footerRow = document.createElement('tr');
      footerRow.classList.add('total-row');
      footerRow.innerHTML = `
        <td colspan="2">TOTALS</td>
        <td>${totals['333'] || ''}</td>
        <td>${totals['332'] || ''}</td>
        <td>${totals['331'] || ''}</td>
        <td>${totals['330'] || ''}</td>
        <td>${totals['313-B'] || ''}</td>
      `;
      reportFooter.appendChild(footerRow);

      reportTable.style.display = '';
      saveBtn.disabled = false;
      printBtn.disabled = false;
    }

    uploadBtn.addEventListener('click', () => {
      const file = fileInput.files[0];
      if (!file) {
        alert('Please select a JSON file.');
        return;
      }
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const json = JSON.parse(e.target.result);
          let arr = [];
          if (Array.isArray(json)) {
            arr = json;
          } else if (json.data && Array.isArray(json.data)) {
            arr = json.data;
          } else {
            throw new Error('JSON must be an array or have a data array property.');
          }

          // Assign temp ids for saving (not used here but good to keep)
          reportData = arr.map((entry, i) => ({
            date: entry.date,
            farm: entry.farm,
            '333': entry['333'] || null,
            '332': entry['332'] || null,
            '331': entry['331'] || null,
            '330': entry['330'] || null,
            '313-B': entry['313-B'] || null,
          }));

          renderReport(reportData);
          messageDiv.textContent = 'JSON loaded. Ready to save or print.';
          messageDiv.style.color = 'green';

        } catch(err) {
          alert('Invalid JSON file: ' + err.message);
        }
      };
      reader.readAsText(file);
    });

    // Save all data to supabase - deletes existing then inserts new
    saveBtn.addEventListener('click', async () => {
      if (!reportData.length) return alert('No data to save.');

      messageDiv.textContent = 'Saving data to cloud... Please wait.';
      messageDiv.style.color = 'black';

      try {
        // Delete all existing data
        let { error: delErr } = await supabase.from('farm_reports').delete().neq('id', 0);
        if (delErr) throw delErr;

        // Insert new data
        let { error: insErr } = await supabase.from('farm_reports').insert(reportData);
        if (insErr) throw insErr;

        messageDiv.textContent = 'Data saved successfully!';
        messageDiv.style.color = 'green';

      } catch(err) {
        messageDiv.textContent = 'Error saving data:
        messageDiv.textContent = 'Error saving data: ' + err.message;
        messageDiv.style.color = 'red';
      }
    });

    // Print button
    printBtn.addEventListener('click', () => {
      window.print();
    });

    // On page load: load any existing data from Supabase
    async function loadDataFromCloud() {
      messageDiv.textContent = 'Loading data from cloud...';
      messageDiv.style.color = 'black';

      try {
        let { data, error } = await supabase
          .from('farm_reports')
          .select('*')
          .order('date', { ascending: true });

        if (error) throw error;

        if (data && data.length) {
          reportData = data;
          renderReport(reportData);
          messageDiv.textContent = 'Loaded data from cloud.';
          messageDiv.style.color = 'green';
          saveBtn.disabled = false;
          printBtn.disabled = false;
        } else {
          messageDiv.textContent = 'No data found in cloud. Upload JSON to begin.';
          messageDiv.style.color = 'gray';
        }
      } catch (err) {
        messageDiv.textContent = 'Error loading data: ' + err.message;
        messageDiv.style.color = 'red';
      }
    }

    // Load data on start
    loadDataFromCloud();
  </script>
</body>
</html>
