<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Professional Ledger</title>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
:root {
    --ruler: 18px;
    --color-red: #AE1100;
    --color-bg: #EBECF0;
    --color-shadow: #BABECC;
    --color-white: #FFF;
    --border-radius: 20px;
    --transition-speed: 0.25s;
    --font-family: 'Poppins', 'Montserrat', sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:var(--font-family);}
body{background:var(--color-bg);display:flex;justify-content:center;padding:40px 0;min-height:100vh;}
.container{width:95%;max-width:1100px;background:var(--color-bg);border-radius:var(--border-radius);box-shadow:-8px -8px 30px var(--color-white),8px 8px 30px var(--color-shadow);padding:40px;display:flex;flex-direction:column;gap:40px;}
.header h1{text-align:center;margin-bottom:20px;}
.header nav{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:20px;}
.tab-btn{padding:12px 25px;border:none;border-radius:var(--border-radius);background:var(--color-bg);cursor:pointer;font-weight:600;box-shadow:-6px -6px 20px var(--color-white),6px 6px 20px var(--color-shadow);}
.tab-btn.active, .tab-btn:hover{box-shadow:inset 2px 2px 8px var(--color-shadow), inset -2px -2px 8px var(--color-white);}
.tab-content{display:none;}
.tab-content.active{display:block;}
form{padding:20px;border-radius:var(--border-radius);box-shadow:-6px -6px 20px var(--color-white),6px 6px 20px var(--color-shadow);display:flex;flex-direction:column;gap:15px;}
input,select,button{padding:12px;border:none;border-radius:var(--border-radius);background:var(--color-bg);box-shadow:inset 3px 3px 8px var(--color-shadow), inset -3px -3px 8px var(--color-white);}
button{cursor:pointer;font-weight:700;}
button:hover{box-shadow:inset 2px 2px 8px var(--color-shadow), inset -2px -2px 8px var(--color-white);}
table{width:100%;border-collapse:collapse;margin-bottom:20px;box-shadow:-6px -6px 20px var(--color-white),6px 6px 20px var(--color-shadow);}
thead th, tbody td{padding:10px;text-align:left;}
tbody tr:hover{background:rgba(0,0,0,0.05);}
.dashboard-cards{display:flex;flex-wrap:wrap;gap:15px;}
.card{flex:1 1 150px;text-align:center;padding:15px;border-radius:var(--border-radius);box-shadow:-6px -6px 20px var(--color-white),6px 6px 20px var(--color-shadow);}
.totals{margin:10px 0;font-weight:600;}
.entryRow{display:flex;gap:5px;margin-bottom:5px;align-items:center;}
.entryRow select,input{flex:1;}
.removeEntryBtn{flex:0;}
@media(max-width:768px){.header nav{flex-direction:column;}.dashboard-cards{flex-direction:column;}}
</style>
</head>
<body>
<div class="container">
<header class="header">
<h1>Professional Personal Ledger</h1>
<nav>
<button class="tab-btn active" data-tab="dashboardTab">Dashboard</button>
<button class="tab-btn" data-tab="accountsTab">Accounts</button>
<button class="tab-btn" data-tab="transactionsTab">Transactions</button>
<button class="tab-btn" data-tab="trialBalanceTab">Trial Balance</button>
<button class="tab-btn" data-tab="reportsTab">Reports</button>
<button class="tab-btn" data-tab="profitLossTab">Profit & Loss</button>
</nav>
</header>

<main>
<!-- Dashboard -->
<section id="dashboardTab" class="tab-content active">
<h2>Dashboard</h2>
<div class="dashboard-cards">
<div class="card">Cash: <span id="totalCash">0</span></div>
<div class="card">Bank: <span id="totalBank">0</span></div>
<div class="card">Credit: <span id="totalCredit">0</span></div>
<div class="card">Assets: <span id="totalAssets">0</span></div>
<div class="card">Liabilities: <span id="totalLiabilities">0</span></div>
<div class="card">Net Wealth: <span id="netWealth">0</span></div>
<div class="card">Profit/Loss: <span id="profitLoss">0</span></div>
</div>
<div id="alerts"></div>
</section>

<!-- Accounts -->
<section id="accountsTab" class="tab-content">
<h2>Accounts</h2>
<form id="accountForm">
<input type="text" id="accountName" placeholder="Account Name" required>
<select id="accountType" required>
<option value="" disabled selected>Select Type</option>
<option value="Cash">Cash</option>
<option value="Bank">Bank</option>
<option value="Credit">Credit</option>
<option value="Income">Income</option>
<option value="Expense">Expense</option>
</select>
<input type="number" id="accountAmount" placeholder="Opening Balance">
<input type="text" id="customCategory" placeholder="Custom Category">
<button type="submit">Add Account</button>
</form>
<input type="text" id="accountSearch" placeholder="Search Accounts">
<table id="accountsTable">
<thead><tr><th>ID</th><th>Name</th><th>Type</th><th>Category</th><th>Balance</th><th>Actions</th></tr></thead>
<tbody></tbody>
</table>
</section>

<!-- Transactions -->
<section id="transactionsTab" class="tab-content">
<h2>Transactions</h2>
<form id="transactionForm">
<input type="text" id="narration" placeholder="Narration" required>
<div id="entriesContainer"></div>
<button type="button" id="addEntryBtn">Add Entry</button>
<div class="totals">Total CR: <span id="totalCR">0</span> | Total DR: <span id="totalDR">0</span></div>
<div class="invoice-info">Voucher ID: <span id="voucherId"></span> | Date/Time: <span id="invoiceDate"></span></div>
<button type="submit">Save Transaction</button>
<button type="button" id="undoBtn">Undo</button>
<button type="button" id="redoBtn">Redo</button>
</form>
<input type="text" id="transactionSearch" placeholder="Search Transactions">
<table id="transactionsTable">
<thead><tr><th>Voucher</th><th>Date</th><th>Narration</th><th>Entries</th><th>Total CR</th><th>Total DR</th><th>Actions</th></tr></thead>
<tbody></tbody>
</table>
</section>

<!-- Trial Balance -->
<section id="trialBalanceTab" class="tab-content">
<h2>Trial Balance</h2>
<input type="text" id="trialSearch" placeholder="Search Trial Balance">
<table id="trialBalanceTable">
<thead><tr><th>Account</th><th>DR</th><th>CR</th><th>Closing</th></tr></thead>
<tbody></tbody>
</table>
<button id="exportTrialPDF">Export Trial Balance PDF</button>
</section>

<!-- Reports -->
<section id="reportsTab" class="tab-content">
<h2>Reports</h2>
<form>
<select id="reportAccount"></select>
From: <input type="date" id="reportFrom">
To: <input type="date" id="reportTo">
<button type="button" id="generateReportBtn">Generate Report</button>
</form>
<table id="reportPreview">
<thead><tr><th>Voucher ID</th><th>Date</th><th>Narration</th><th>Entries</th></tr></thead>
<tbody></tbody>
</table>
<button type="button" id="exportReportPDF">Export Report PDF</button>
</section>

<!-- Profit & Loss -->
<section id="profitLossTab" class="tab-content">
<h2>Profit & Loss</h2>
<table id="profitLossTable">
<thead><tr><th>Account</th><th>DR</th><th>CR</th><th>Net</th></tr></thead>
<tbody></tbody>
</table>
<button id="exportPLPDF">Export P&L PDF</button>
</section>
</main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";

// ===== FIREBASE CONFIG =====
const firebaseConfig = {
  apiKey: "AIzaSyASyNIjdLYUEszSNFHJZ-9hADPuyth5Ag8",
  authDomain: "personalledger-9fbdb.firebaseapp.com",
  projectId: "personalledger-9fbdb",
  storageBucket: "personalledger-9fbdb.firebasestorage.app",
  messagingSenderId: "555377240895",
  appId: "1:555377240895:web:90937044fac6d5a832018a",
  measurementId: "G-872C8RDS4Y"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getFirestore(app);

// ===== LEDGER DATA =====
let accounts = [];
let transactions = [];
let undoStack = [];
let redoStack = [];

// ===== FIRESTORE CRUD =====
async function saveAccount(acc){
  await setDoc(doc(db,"accounts",acc.id), acc);
}
async function saveTransaction(tx){
  await setDoc(doc(db,"transactions",tx.id), tx);
}
async function deleteAccountFirestore(id){
  await deleteDoc(doc(db,"accounts",id));
}
async function deleteTransactionFirestore(id){
  await deleteDoc(doc(db,"transactions",id));
}

async function loadData(){
  accounts = [];
  transactions = [];

  const accSnap = await getDocs(collection(db,"accounts"));
  accSnap.forEach(d=>accounts.push(d.data()));

  const txSnap = await getDocs(collection(db,"transactions"));
  txSnap.forEach(d=>transactions.push(d.data()));

  renderAccounts();
  renderTransactions();
  generateTrialBalance();
  generateProfitLoss();
  updateDashboard();
}

// ===== HELPER FUNCTIONS =====
function generateId(prefix,arr){
  return prefix+(arr.length>0?Math.max(...arr.map(a=>parseInt(a.id.replace(prefix,''))))+1:1001);
}
function getKarachiTime(){
  const now = new Date();
  const offset=5*60; 
  const localOffset=now.getTimezoneOffset(); 
  const utc = now.getTime()+localOffset*60*1000;
  const dt = new Date(utc+offset*60*1000);
  return dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0')+' '+String(dt.getHours()).padStart(2,'0')+':'+String(dt.getMinutes()).padStart(2,'0')+':'+String(dt.getSeconds()).padStart(2,'0');
}

// ===== TABS =====
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});

// ===== ACCOUNTS =====
function renderAccounts(search=''){
  const tbody=document.querySelector('#accountsTable tbody'); tbody.innerHTML='';
  accounts.filter(a=>a.name.toLowerCase().includes(search.toLowerCase()))
    .forEach(acc=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${acc.id}</td><td>${acc.name}</td><td>${acc.type}</td><td>${acc.category||'-'}</td><td>${acc.balance.toFixed(2)}</td>
      <td><button onclick="editAccount('${acc.id}')">Edit</button> <button onclick="deleteAccount('${acc.id}')">Delete</button></td>`;
      tbody.appendChild(tr);
    });
  populateReportAccounts();
}

document.getElementById('accountForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const name=document.getElementById('accountName').value;
  const type=document.getElementById('accountType').value;
  const amount=parseFloat(document.getElementById('accountAmount').value)||0;
  const category=document.getElementById('customCategory').value;
  const id=generateId('A',accounts);
  const newAcc = {id,name,type,balance:amount,category};
  accounts.push(newAcc);
  await saveAccount(newAcc);
  renderAccounts();
  updateDashboard();
  document.getElementById('accountForm').reset();
});

window.editAccount = async function(id){
  const acc=accounts.find(a=>a.id===id); if(!acc) return;
  const newName=prompt('Edit Account Name:',acc.name); if(newName) acc.name=newName;
  await saveAccount(acc);
  renderAccounts();
  updateDashboard();
}

window.deleteAccount = async function(id){
  if(!confirm('Delete this account?')) return;
  accounts = accounts.filter(a=>a.id!==id);
  await deleteAccountFirestore(id);
  renderAccounts();
  updateDashboard();
}

function populateReportAccounts(){
  const sel=document.getElementById('reportAccount'); if(!sel) return;
  sel.innerHTML='<option value="">All Accounts</option>';
  accounts.forEach(a=>{sel.innerHTML+=`<option value="${a.id}">${a.name}</option>`;});
}

// ===== TRANSACTIONS =====
function renderTransactions(search=''){
  const tbody=document.querySelector('#transactionsTable tbody'); tbody.innerHTML='';
  transactions.filter(t=>t.narration.toLowerCase().includes(search.toLowerCase()))
    .forEach(tx=>{
      const tr=document.createElement('tr');
      const entriesHtml = tx.entries.map(e=>`${e.accountName}(${e.type}:${e.amount.toFixed(2)})`).join('<br>');
      tr.innerHTML=`<td>${tx.id}</td><td>${tx.date}</td><td>${tx.narration}</td><td>${entriesHtml}</td><td>${tx.totalCR.toFixed(2)}</td><td>${tx.totalDR.toFixed(2)}</td>
      <td><button onclick="deleteTransaction('${tx.id}')">Delete</button></td>`;
      tbody.appendChild(tr);
    });
}

document.getElementById('addEntryBtn').addEventListener('click',()=>{
  const container=document.getElementById('entriesContainer');
  const div=document.createElement('div'); div.className='entryRow';
  div.innerHTML=`<select class="entryAccount" required><option value="" disabled selected>Choose Account</option>${accounts.map(a=>`<option value="${a.id}">${a.name}</option>`).join('')}</select>
  <input type="number" class="entryAmount" placeholder="Amount" required>
  <select class="entryType"><option value="DR">DR</option><option value="CR">CR</option></select>
  <button type="button" class="removeEntryBtn">Remove</button>`;
  container.appendChild(div);
  div.querySelector('.removeEntryBtn').addEventListener('click',()=>{div.remove();updateTotals();});
  div.querySelectorAll('.entryAmount,.entryType,.entryAccount').forEach(el=>el.addEventListener('input',updateTotals));
});

function updateTotals(){
  let dr=0, cr=0;
  document.querySelectorAll('.entryRow').forEach(r=>{
    const amt=parseFloat(r.querySelector('.entryAmount').value)||0;
    const t=r.querySelector('.entryType').value;
    if(t==='DR') dr+=amt; else cr+=amt;
  });
  document.getElementById('totalDR').textContent=dr.toFixed(2);
  document.getElementById('totalCR').textContent=cr.toFixed(2);
}

document.getElementById('transactionForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const narration=document.getElementById('narration').value;
  const date=getKarachiTime();
  const id=generateId('V',transactions);
  const entries=[];
  let dr=0, cr=0;
  document.querySelectorAll('.entryRow').forEach(r=>{
    const accId=r.querySelector('.entryAccount').value;
    const acc=accounts.find(a=>a.id===accId);
    const amt=parseFloat(r.querySelector('.entryAmount').value)||0;
    const t=r.querySelector('.entryType').value;
    if(t==='DR') dr+=amt; else cr+=amt;
    entries.push({accountId:accId, accountName:acc.name, amount:amt, type:t});
  });
  if(dr!==cr){ alert('DR and CR must match'); return; }
  entries.forEach(e=>{
    const acc=accounts.find(a=>a.id===e.accountId);
    if(e.type==='DR') acc.balance+=e.amount; else acc.balance-=e.amount;
    saveAccount(acc);
  });
  const tx={id,date,narration,entries,totalDR:dr,totalCR:cr};
  transactions.push(tx);
  undoStack.push({type:'addTx',data:tx}); redoStack=[];
  await saveTransaction(tx);
  renderTransactions(); renderAccounts(); updateDashboard();
  document.getElementById('transactionForm').reset();
  document.getElementById('entriesContainer').innerHTML='';
  updateTotals();
});

window.deleteTransaction = async function(id){
  const tx=transactions.find(t=>t.id===id); if(!tx) return;
  tx.entries.forEach(e=>{
    const acc=accounts.find(a=>a.id===e.accountId);
    if(e.type==='DR') acc.balance-=e.amount; else acc.balance+=e.amount;
    saveAccount(acc);
  });
  transactions = transactions.filter(t=>t.id!==id);
  await deleteTransactionFirestore(id);
  renderTransactions(); renderAccounts(); updateDashboard();
}

// ===== DASHBOARD =====
function updateDashboard(){
  const totalCash=accounts.filter(a=>a.type==='Cash').reduce((s,a)=>s+a.balance,0);
  const totalBank=accounts.filter(a=>a.type==='Bank').reduce((s,a)=>s+a.balance,0);
  const totalCredit=accounts.filter(a=>a.type==='Credit').reduce((s,a)=>s+a.balance,0);
  const totalAssets=accounts.filter(a=>['Cash','Bank','Income','Assets'].includes(a.type)).reduce((s,a)=>s+a.balance,0);
  const totalLiabilities=accounts.filter(a=>['Credit','Liabilities','Expense'].includes(a.type)).reduce((s,a)=>s+a.balance,0);
  const profitLoss=accounts.filter(a=>['Income','Expense'].includes(a.type)).reduce((s,a)=>a.type==='Income'?s+a.balance:s-a.balance,0);
  const netWealth=totalAssets-totalLiabilities;
  document.getElementById('totalCash').textContent=totalCash.toFixed(2);
  document.getElementById('totalBank').textContent=totalBank.toFixed(2);
  document.getElementById('totalCredit').textContent=totalCredit.toFixed(2);
  document.getElementById('totalAssets').textContent=totalAssets.toFixed(2);
  document.getElementById('totalLiabilities').textContent=totalLiabilities.toFixed(2);
  document.getElementById('netWealth').textContent=netWealth.toFixed(2);
  document.getElementById('profitLoss').textContent=profitLoss.toFixed(2);
  const alerts=accounts.filter(a=>a.balance<0).map(a=>`${a.name} has negative balance!`);
  document.getElementById('alerts').innerHTML=alerts.join('<br>');
}

// ===== SEARCH =====
document.getElementById('accountSearch').addEventListener('input',e=>renderAccounts(e.target.value));
document.getElementById('transactionSearch').addEventListener('input',e=>renderTransactions(e.target.value));

// ===== INITIAL LOAD =====
loadData();
</script>

</body>
</html>
