<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Professional Ledger - Firebase</title>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
:root {
    --ruler: 18px;
    --color-red: #AE1100;
    --color-bg: #EBECF0;
    --color-shadow: #BABECC;
    --color-white: #FFF;
    --border-radius: 20px;
    --transition-speed: 0.25s;
    --font-family: 'Poppins', 'Montserrat', sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:var(--font-family);}
body{background:var(--color-bg);display:flex;justify-content:center;padding:40px 0;min-height:100vh;}
.container{width:95%;max-width:1100px;background:var(--color-bg);border-radius:var(--border-radius);box-shadow:-8px -8px 30px var(--color-white),8px 8px 30px var(--color-shadow);padding:40px;display:flex;flex-direction:column;gap:40px;}
.header h1{text-align:center;margin-bottom:20px;}
.header nav{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:20px;}
.tab-btn{padding:12px 25px;border:none;border-radius:var(--border-radius);background:var(--color-bg);cursor:pointer;font-weight:600;box-shadow:-6px -6px 20px var(--color-white),6px 6px 20px var(--color-shadow);}
.tab-btn.active, .tab-btn:hover{box-shadow:inset 2px 2px 8px var(--color-shadow), inset -2px -2px 8px var(--color-white);}
.tab-content{display:none;}
.tab-content.active{display:block;}
form{padding:20px;border-radius:var(--border-radius);box-shadow:-6px -6px 20px var(--color-white),6px 6px 20px var(--color-shadow);display:flex;flex-direction:column;gap:15px;}
input,select,button{padding:12px;border:none;border-radius:var(--border-radius);background:var(--color-bg);box-shadow:inset 3px 3px 8px var(--color-shadow), inset -3px -3px 8px var(--color-white);}
button{cursor:pointer;font-weight:700;}
button:hover{box-shadow:inset 2px 2px 8px var(--color-shadow), inset -2px -2px 8px var(--color-white);}
table{width:100%;border-collapse:collapse;margin-bottom:20px;box-shadow:-6px -6px 20px var(--color-white),6px 6px 20px var(--color-shadow);}
thead th, tbody td{padding:10px;text-align:left;}
tbody tr:hover{background:rgba(0,0,0,0.05);}
.dashboard-cards{display:flex;flex-wrap:wrap;gap:15px;}
.card{flex:1 1 150px;text-align:center;padding:15px;border-radius:var(--border-radius);box-shadow:-6px -6px 20px var(--color-white),6px 6px 20px var(--color-shadow);}
.totals{margin:10px 0;font-weight:600;}
.entryRow{display:flex;gap:5px;margin-bottom:5px;align-items:center;}
.entryRow select,input{flex:1;}
.removeEntryBtn{flex:0;}
@media(max-width:768px){.header nav{flex-direction:column;}.dashboard-cards{flex-direction:column;}}
</style>
</head>
<body>
<div class="container">
<header class="header">
<h1>Professional Personal Ledger - Firebase</h1>
<nav>
<button class="tab-btn active" data-tab="dashboardTab">Dashboard</button>
<button class="tab-btn" data-tab="accountsTab">Accounts</button>
<button class="tab-btn" data-tab="transactionsTab">Transactions</button>
<button class="tab-btn" data-tab="trialBalanceTab">Trial Balance</button>
<button class="tab-btn" data-tab="reportsTab">Reports</button>
<button class="tab-btn" data-tab="profitLossTab">Profit & Loss</button>
</nav>
</header>

<main>
<!-- Dashboard -->
<section id="dashboardTab" class="tab-content active">
<h2>Dashboard</h2>
<div class="dashboard-cards">
<div class="card">Cash: <span id="totalCash">0</span></div>
<div class="card">Bank: <span id="totalBank">0</span></div>
<div class="card">Credit: <span id="totalCredit">0</span></div>
<div class="card">Assets: <span id="totalAssets">0</span></div>
<div class="card">Liabilities: <span id="totalLiabilities">0</span></div>
<div class="card">Net Wealth: <span id="netWealth">0</span></div>
<div class="card">Profit/Loss: <span id="profitLoss">0</span></div>
</div>
<div id="alerts"></div>
</section>

<!-- Accounts -->
<section id="accountsTab" class="tab-content">
<h2>Accounts</h2>
<form id="accountForm">
<input type="text" id="accountName" placeholder="Account Name" required>
<select id="accountType" required>
<option value="" disabled selected>Select Type</option>
<option value="Cash">Cash</option>
<option value="Bank">Bank</option>
<option value="Credit">Credit</option>
<option value="Income">Income</option>
<option value="Expense">Expense</option>
</select>
<input type="number" id="accountAmount" placeholder="Opening Balance">
<button type="submit">Add Account</button>
</form>
<input type="text" id="accountSearch" placeholder="Search Accounts">
<table id="accountsTable">
<thead><tr><th>ID</th><th>Name</th><th>Type</th><th>Balance</th><th>Actions</th></tr></thead>
<tbody></tbody>
</table>
</section>

<!-- Transactions -->
<section id="transactionsTab" class="tab-content">
<h2>Transactions</h2>
<form id="transactionForm">
<input type="text" id="narration" placeholder="Narration" required>
<div id="entriesContainer"></div>
<button type="button" id="addEntryBtn">Add Entry</button>
<div class="totals">Total CR: <span id="totalCR">0</span> | Total DR: <span id="totalDR">0</span></div>
<button type="submit">Save Transaction</button>
</form>
<input type="text" id="transactionSearch" placeholder="Search Transactions">
<table id="transactionsTable">
<thead><tr><th>Voucher</th><th>Date</th><th>Narration</th><th>Entries</th><th>Total CR</th><th>Total DR</th></tr></thead>
<tbody></tbody>
</table>
</section>

<!-- Trial Balance -->
<section id="trialBalanceTab" class="tab-content">
<h2>Trial Balance</h2>
<table id="trialBalanceTable">
<thead><tr><th>Account</th><th>DR</th><th>CR</th><th>Closing</th></tr></thead>
<tbody></tbody>
</table>
<button id="exportTrialPDF">Export Trial Balance PDF</button>
</section>

<!-- Reports -->
<section id="reportsTab" class="tab-content">
<h2>Reports</h2>
<select id="reportAccount"></select>
From: <input type="date" id="reportFrom">
To: <input type="date" id="reportTo">
<button id="generateReportBtn">Generate Report</button>
<table id="reportPreview">
<thead><tr><th>Voucher ID</th><th>Date</th><th>Narration</th><th>Entries</th></tr></thead>
<tbody></tbody>
</table>
<button id="exportReportPDF">Export Report PDF</button>
</section>

<!-- Profit & Loss -->
<section id="profitLossTab" class="tab-content">
<h2>Profit & Loss</h2>
<table id="profitLossTable">
<thead><tr><th>Account</th><th>DR</th><th>CR</th><th>Net</th></tr></thead>
<tbody></tbody>
</table>
<button id="exportPLPDF">Export P&L PDF</button>
</section>
</main>
</div>

<!-- Firebase + Ledger JS -->
<script type="module">

import { 
    initializeApp 
} from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { 
    getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy 
} from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyD7mXu8geRhtnNNGo5LeyBoDaj8gUQGQic",
    authDomain: "personal-ledger-acef3.firebaseapp.com",
    projectId: "personal-ledger-acef3",
    storageBucket: "personal-ledger-acef3.firebasestorage.app",
    messagingSenderId: "65575098004",
    appId: "1:65575098004:web:f3ba84298bb5497a39c681",
    measurementId: "G-1QW5HRC13W"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const accountsCol = collection(db, "accounts");
const transactionsCol = collection(db, "transactions");

// ---------------- Tabs ----------------
document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
        document.getElementById(btn.dataset.tab).classList.add('active');
    });
});

// ---------------- Accounts ----------------
let accounts = [];
function renderAccounts(search='') {
    const tbody = document.querySelector('#accountsTable tbody'); tbody.innerHTML='';
    accounts.filter(a=>a.name.toLowerCase().includes(search.toLowerCase())).forEach(acc=>{
        const tr = document.createElement('tr');
        tr.innerHTML=`<td>${acc.id}</td><td>${acc.name}</td><td>${acc.type}</td><td>${acc.balance.toFixed(2)}</td>
        <td><button onclick="editAccount('${acc.id}')">Edit</button> <button onclick="deleteAccount('${acc.id}')">Delete</button></td>`;
        tbody.appendChild(tr);
    });
    populateReportAccounts();
}

function populateReportAccounts(){
    const sel = document.getElementById('reportAccount');
    if(!sel) return;
    sel.innerHTML='<option value="">All Accounts</option>';
    accounts.forEach(a=>{ sel.innerHTML += `<option value="${a.id}">${a.name}</option>`; });
}

// Real-time listener for accounts
onSnapshot(query(accountsCol, orderBy("name")), snapshot=>{
    accounts = [];
    snapshot.forEach(doc => accounts.push(doc.data()));
    renderAccounts();
    updateDashboard();
});

// Add account
document.getElementById('accountForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const name = document.getElementById('accountName').value;
    const type = document.getElementById('accountType').value;
    const balance = parseFloat(document.getElementById('accountAmount').value)||0;
    const docRef = await addDoc(accountsCol, { name, type, balance });
    await updateDoc(doc(accountsCol, docRef.id), { id: docRef.id });
    e.target.reset();
});

// Edit & Delete functions
window.editAccount = async function(id){
    const acc = accounts.find(a=>a.id===id);
    if(!acc) return;
    const newName = prompt('Edit Account Name:', acc.name);
    if(newName) await updateDoc(doc(accountsCol, id), { name: newName });
}
window.deleteAccount = async function(id){
    if(!confirm('Delete this account?')) return;
    await deleteDoc(doc(accountsCol, id));
}

// ---------------- Transactions ----------------
let transactions = [];
function renderTransactions(search='') {
    const tbody = document.querySelector('#transactionsTable tbody'); tbody.innerHTML='';
    transactions.filter(t=>t.narration.toLowerCase().includes(search.toLowerCase())).forEach(tx=>{
        const entriesHtml = tx.entries.map(e=>`${e.accountName}(${e.type}:${e.amount.toFixed(2)})`).join('<br>');
        const tr = document.createElement('tr');
        tr.innerHTML=`<td>${tx.id}</td><td>${tx.date}</td><td>${tx.narration}</td><td>${entriesHtml}</td><td>${tx.totalCR.toFixed(2)}</td><td>${tx.totalDR.toFixed(2)}</td>`;
        tbody.appendChild(tr);
    });
}

// Real-time listener for transactions
onSnapshot(query(transactionsCol, orderBy("date")), snapshot=>{
    transactions = [];
    snapshot.forEach(doc => transactions.push(doc.data()));
    renderTransactions();
});

// Add transaction
document.getElementById('addEntryBtn').addEventListener('click', ()=>{
    const container = document.getElementById('entriesContainer');
    const div = document.createElement('div'); div.className='entryRow';
    div.innerHTML = `<select class="entryAccount" required><option value="" disabled selected>Choose Account</option>${accounts.map(a=>`<option value="${a.id}">${a.name}</option>`).join('')}</select>
    <input type="number" class="entryAmount" placeholder="Amount" required>
    <select class="entryType"><option value="DR">DR</option><option value="CR">CR</option></select>
    <button type="button" class="removeEntryBtn">Remove</button>`;
    container.appendChild(div);
    div.querySelector('.removeEntryBtn').addEventListener('click',()=>{div.remove();updateTotals();});
    div.querySelectorAll('.entryAmount,.entryType,.entryAccount').forEach(el=>el.addEventListener('input',updateTotals));
});

// Update totals
function updateTotals(){
    let dr=0, cr=0;
    document.querySelectorAll('.entryRow').forEach(r=>{
        const amt=parseFloat(r.querySelector('.entryAmount').value)||0;
        const t=r.querySelector('.entryType').value;
        if(t==='DR') dr+=amt; else cr+=amt;
    });
    document.getElementById('totalDR').textContent = dr.toFixed(2);
    document.getElementById('totalCR').textContent = cr.toFixed(2);
}

// Submit transaction
document.getElementById('transactionForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const narration = document.getElementById('narration').value;
    const date = new Date().toISOString();
    const entries = [];
    let dr=0, cr=0;
    document.querySelectorAll('.entryRow').forEach(r=>{
        const accId = r.querySelector('.entryAccount').value;
        const acc = accounts.find(a=>a.id===accId);
        const amt = parseFloat(r.querySelector('.entryAmount').value)||0;
        const type = r.querySelector('.entryType').value;
        if(type==='DR') dr+=amt; else cr+=amt;
        entries.push({ accountId: accId, accountName: acc.name, amount: amt, type });
    });
    if(dr!==cr){ alert('DR and CR must match'); return; }
    // Update balances
    entries.forEach(e=>{
        const acc = accounts.find(a=>a.id===e.accountId);
        const newBalance = e.type==='DR'?acc.balance+e.amount:acc.balance-e.amount;
        updateDoc(doc(accountsCol, e.accountId), { balance: newBalance });
    });
    const docRef = await addDoc(transactionsCol, { date, narration, entries, totalDR: dr, totalCR: cr });
    await updateDoc(doc(transactionsCol, docRef.id), { id: docRef.id });
    e.target.reset(); document.getElementById('entriesContainer').innerHTML=''; updateTotals();
});

// Search filters
document.getElementById('accountSearch').addEventListener('input', e=> renderAccounts(e.target.value));
document.getElementById('transactionSearch').addEventListener('input', e=> renderTransactions(e.target.value));

// ---------------- Dashboard ----------------
function updateDashboard(){
    const totalCash = accounts.filter(a=>a.type==='Cash').reduce((s,a)=>s+a.balance,0);
    const totalBank = accounts.filter(a=>a.type==='Bank').reduce((s,a)=>s+a.balance,0);
    const totalCredit = accounts.filter(a=>a.type==='Credit').reduce((s,a)=>s+a.balance,0);
    const totalAssets = accounts.filter(a=>['Cash','Bank','Income','Assets'].includes(a.type)).reduce((s,a)=>s+a.balance,0);
    const totalLiabilities = accounts.filter(a=>['Credit','Liabilities','Expense'].includes(a.type)).reduce((s,a)=>s+a.balance,0);
    const profitLoss = accounts.filter(a=>['Income','Expense'].includes(a.type)).reduce((s,a)=>a.type==='Income'?s+a.balance:s-a.balance,0);
    const netWealth = totalAssets - totalLiabilities;
    const alerts = accounts.filter(a=>a.balance<0).map(a=>`${a.name} has negative balance!`);
    document.getElementById('totalCash').textContent = totalCash.toFixed(2);
    document.getElementById('totalBank').textContent = totalBank.toFixed(2);
    document.getElementById('totalCredit').textContent = totalCredit.toFixed(2);
    document.getElementById('totalAssets').textContent = totalAssets.toFixed(2);
    document.getElementById('totalLiabilities').textContent = totalLiabilities.toFixed(2);
    document.getElementById('profitLoss').textContent = profitLoss.toFixed(2);
    document.getElementById('netWealth').textContent = netWealth.toFixed(2);
    document.getElementById('alerts').innerHTML = alerts.join('<br>');
}

// ---------------- Trial Balance ----------------
function renderTrialBalance(){
    const tbody = document.getElementById('trialBalanceTable').querySelector('tbody'); tbody.innerHTML='';
    accounts.forEach(acc=>{
        let DR=0, CR=0;
        transactions.forEach(tx=>{
            tx.entries.forEach(e=>{
                if(e.accountId===acc.id){ if(e.type==='DR') DR+=e.amount; else CR+=e.amount; }
            });
        });
        const tr = document.createElement('tr');
        tr.innerHTML=`<td>${acc.name}</td><td>${DR.toFixed(2)}</td><td>${CR.toFixed(2)}</td><td>${acc.balance.toFixed(2)}</td>`;
        tbody.appendChild(tr);
    });
}
document.getElementById('exportTrialPDF').addEventListener('click', ()=>{
    const doc = new jsPDF(); doc.text('Trial Balance',105,10,null,null,'center');
    const body = Array.from(document.querySelectorAll('#trialBalanceTable tbody tr')).map(tr=>Array.from(tr.children).map(td=>td.textContent));
    doc.autoTable({ head:[['Account','DR','CR','Closing']], body, startY:20, theme:'grid' });
    doc.save('TrialBalance.pdf');
});

// ---------------- Reports ----------------
document.getElementById('generateReportBtn').addEventListener('click', ()=>{
    const accountId = document.getElementById('reportAccount').value;
    const from = document.getElementById('reportFrom').value;
    const to = document.getElementById('reportTo').value;
    const tbody = document.getElementById('reportPreview').querySelector('tbody'); tbody.innerHTML='';
    const filtered = transactions.filter(tx=>{
        const txDate = tx.date.split('T')[0];
        const inRange = (!from||txDate>=from) && (!to||txDate<=to);
        const match = !accountId || tx.entries.some(e=>e.accountId===accountId);
        return inRange && match;
    });
    filtered.forEach(tx=>{
        const entriesHtml = tx.entries.map(e=>`${e.accountName}(${e.type}:${e.amount.toFixed(2)})`).join('<br>');
        const tr = document.createElement('tr');
        tr.innerHTML=`<td>${tx.id}</td><td>${tx.date.split('T')[0]}</td><td>${tx.narration}</td><td>${entriesHtml}</td>`;
        tbody.appendChild(tr);
    });
});
document.getElementById('exportReportPDF').addEventListener('click', ()=>{
    const table = document.getElementById('reportPreview');
    const doc = new jsPDF(); doc.text('Transactions Report',105,10,null,null,'center');
    const body = Array.from(table.querySelectorAll('tbody tr')).map(tr=>Array.from(tr.children).map(td=>td.textContent));
    doc.autoTable({ head:[['Voucher','Date','Narration','Entries']], body, startY:20, theme:'grid' });
    doc.save('TransactionsReport.pdf');
});

// ---------------- Profit & Loss ----------------
function renderPL(){
    const tbody = document.getElementById('profitLossTable').querySelector('tbody'); tbody.innerHTML='';
    accounts.filter(a=>['Income','Expense'].includes(a.type)).forEach(acc=>{
        let DR=0, CR=0;
        transactions.forEach(tx=>{
            tx.entries.forEach(e=>{
                if(e.accountId===acc.id){ if(e.type==='DR') DR+=e.amount; else CR+=e.amount; }
            });
        });
        const net = acc.type==='Income'?CR-DR:DR-CR;
        const tr = document.createElement('tr');
        tr.innerHTML=`<td>${acc.name}</td><td>${DR.toFixed(2)}</td><td>${CR.toFixed(2)}</td><td>${net.toFixed(2)}</td>`;
        tbody.appendChild(tr);
    });
}
document.getElementById('exportPLPDF').addEventListener('click', ()=>{
    const table = document.getElementById('profitLossTable');
    const doc = new jsPDF(); doc.text('Profit & Loss',105,10,null,null,'center');
    const body = Array.from(table.querySelectorAll('tbody tr')).map(tr=>Array.from(tr.children).map(td=>td.textContent));
    doc.autoTable({ head:[['Account','DR','CR','Net']], body, startY:20, theme:'grid' });
    doc.save('ProfitLoss.pdf');
});

// Real-time render triggers
setInterval(()=>{ renderTrialBalance(); renderPL(); },1000);

</script>
</body>
</html>
